<div id="callRecords-area">
    <app-page-header [title]="'呼入记录'"></app-page-header>
    <div class="h-100">
        <div class="row head-search-container">
             <div class="col-2 container-input" *ngIf="rolePermission == 11||rolePermission == 5">
                <dl>
                    <dt>客户:</dt>
                    <dd>
                        <!--<mat-form-field class="right-input" [floatPlaceholder]="'never'">
                            <mat-select [(ngModel)]="paramsApp.accountId" placeholder="请选择" (change)="getAccountApp()">
                                <mat-option *ngFor="let item of userIdArr" [value]="item?.id">
                                    {{item?.fullName}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>-->
                        <mat-form-field class="right-input" [floatPlaceholder]="'never'">
                            <input matInput
                                   [(ngModel)]="accountName"
                                   [typeahead]="userIdArr"
                                   typeaheadOptionField="fullName"
                                   (typeaheadOnSelect)="typeaheadOnSelect($event)"
                                   (typeaheadOnBlur) = "typeaheadOnBlur($event)"
                                   [typeaheadOptionsLimit]="userIdArr.length"
                                   [typeaheadMinLength]="0"
                                   [typeaheadScrollable]="true"
                                   [typeaheadOptionsInScrollableView]="10"
                                   placeholder="请选择"
                                   class="form-control">
                        </mat-form-field>
                    </dd>
                </dl>
            </div>
            <div class="col-2 container-input">
                <dl>
                    <dt>应用:</dt>
                    <dd>
                        <mat-form-field class="right-input" [floatPlaceholder]="'never'">
                            <mat-select [(ngModel)]="params.appId" placeholder="请选择">
                                <mat-option *ngFor="let item of appIdArr" [value]="item?.appId">
                                    {{item?.appName}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </dd>
                </dl>
            </div>
            <div class="col-2 container-input">
                <dl>
                    <dt>号码类型:</dt>
                    <dd>
                        <mat-form-field class="right-input" [floatPlaceholder]="'never'">
                            <mat-select [(ngModel)]="params.cdrInstance" placeholder="请选择">
                                <mat-option
                                        *ngFor="let item of [{name:'客户号码',value:'customer_number'},{name:'热线号码',value:'hotline'},{name:'呼转号码',value:'callee_number'},{name:'呼转外显号码',value:'callee_clid_number'}]"
                                        [value]="item?.value">
                                    {{item?.name}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </dd>
                </dl>
            </div>
            <div class="col-2 container-input">
                <dl>
                    <dd>
                        <mat-form-field class="right-input" [floatPlaceholder]="'never'">
                            <input matInput placeholder="请输入" [(ngModel)]="params.cdrInstanceValue">
                        </mat-form-field>
                    </dd>
                </dl>
            </div>
            <div class="col-2 container-input">
                <dl>
                    <dt>接听状态:</dt>
                    <dd>
                        <mat-form-field class="right-input" [floatPlaceholder]="'never'">
                            <mat-select [(ngModel)]="params.status" placeholder="请选择">
                                <mat-option
                                        *ngFor="let item of [{name:'全部',value:''},{name:'呼转接听',value:'telBridged'},{name:'已呼转未接听',value:'telCalled'},{name:'系统接听',value:'systemAnswer'},{name:'系统未接听',value:'systemNoAnswer'}]"
                                        [value]="item?.value">
                                    {{item?.name}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </dd>
                </dl>
            </div>
            <div class="col-5 container-input">
                <dl>
                    <dt>查询时间:</dt>
                    <dd class="range-flatpickr">
                        <ng2-flatpickr [config]="startTimeOptions"></ng2-flatpickr>
                        至
                        <ng2-flatpickr [config]="endTimeOptions"></ng2-flatpickr>
                    </dd>
                </dl>
            </div>
            <div class="col-3">
                <button mat-button class="search-button" (click)="search()">搜索</button>
                <button mat-button class="search-button" (click)="export()">导出</button>
            </div>
        </div>
        <div class="table-container w-100">
            <ngx-datatable class="material striped"
                           [rows]="callRecords"
                           [headerHeight]="40"
                           [footerHeight]="40"
                           [rowHeight]="40"
                           [columnMode]="'force'"
                           [scrollbarH]="true"
                           [limit]="params.limit">
                <ngx-datatable-column name="呼入号码" [prop]="'customerNumber'"></ngx-datatable-column>
                <ngx-datatable-column name="接入号码" [prop]="'accessNumber'"></ngx-datatable-column>
                <ngx-datatable-column name="转接号码" [prop]="'bridgeNumber'"></ngx-datatable-column>
                <ngx-datatable-column name="呼转外显号码" [prop]="'clidNumber'"></ngx-datatable-column>
                <ngx-datatable-column name="系统应答时间" [prop]="'answerTimeStr'"></ngx-datatable-column>
                <ngx-datatable-column name="转接接通时间" [prop]="'bridgeTimeStr'"></ngx-datatable-column>
                <ngx-datatable-column name="通话结束时间" [prop]="'endTimeStr'"></ngx-datatable-column>
                <ngx-datatable-column name="通话状态" [prop]="'statusDesc'"></ngx-datatable-column>
                <ngx-datatable-column name="录音">
                    <ng-template let-row="row" let-rowIndex="rowIndex" ngx-datatable-cell-template>
                        <span *ngIf="row.recordFile!=''&&row.recordFile!='<5s'"
                              (click)="listenRecord(row)" class="h_play_start"></span>
                        <span *ngIf="row.recordFile!=''&&row.recordFile!='<5s'" class="h_download" (click)="downfile($event,row,null)"></span>
                        <span *ngIf="row.recordFile==''||row.recordFile=='<5s'" style="display: inline-block; width: 24px; height: 24px;"></span>
                    </ng-template>
                </ngx-datatable-column>
                <ngx-datatable-footer>
                    <ng-template ngx-datatable-footer-template>
                        <app-pagination [pageParams]="params" [comTotalCount]="totalCount"
                                        (limitChange)="getLimit($event)"
                                        (pageParamsChange)="reloadOperateDailyCount($event)"></app-pagination>
                    </ng-template>
                </ngx-datatable-footer>
            </ngx-datatable>
            <iframe [src]="downiframe" width="0" height="0" style="display: none;"></iframe>
        </div>
        <div class="w-100">
            <div class="w-100">
                <span>合计: 接通时长{{callRecordsTotal.billDurationsTotal}}</span>
                <span> 桥接时长{{callRecordsTotal.bridgeDurationsTotal}}</span>
                <span>计费时长{{callRecordsTotal.billDurationsTotal}}分钟</span>
            </div>
        </div>
        <div class="w-100" style="height: 30px">
            <audio [src]="recordSrc" autoplay controls
                   style="display: none;width: 90%;float: left;"></audio>
            <span id="closeRecordButton"
                  style="display:none;width:14px;height:13px;background:url(../../../assets/images/audio/audio_close.png) no-repeat 0 0;float: left;background-position:-14px 0px;"
                  (click)="closeRecord()" title="关闭播放器"></span>
        </div>
    </div>
    <app-loading *ngIf="isSpinner === 1" [top]="'300px'"></app-loading>
    <app-empty-data *ngIf="isPermission === 0"></app-empty-data>
</div>